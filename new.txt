import React, { Component } from 'react';
import { Container, Header, Title, Content, Footer, FooterTab, Button, Left, Right, Body, Thumbnail, Icon } from 'native-base';
import { Dimensions, ImageBackground, StyleSheet, View, Text, SafeAreaView, Image, TextInput, TouchableOpacity, Alert, Modal, ActivityIndicator } from 'react-native';
import { widthPercentageToDP as wp, heightPercentageToDP as hp, listenOrientationChange as lor, removeOrientationListener as rol, } from 'react-native-responsive-screen';
import firestore from '@react-native-firebase/firestore';
import AsyncStorage from '@react-native-community/async-storage';
import functions from '@react-native-firebase/functions';
import moment from "moment";
import RN_Icon from 'react-native-vector-icons/AntDesign';

const styles = StyleSheet.create({
  header_bg: {
    backgroundColor: "#FFFFFF",
    elevation: 0,
    borderBottomWidth: 1,
    borderBottomColor: '#D4D4D4',
    marginLeft: 10,
    marginRight: 10
  },
  Header_Body: {
    flex: 4,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#FFFFFF',
  },
  Header_Name: {
    fontFamily: 'NotoSans-Regular',
    color: '#2570EC',
    fontSize: 20,
    fontStyle: 'normal',
    fontWeight: '700'
  },
  content: {
    padding: 20
  },
})

class confirm_Appointment extends React.Component {

  state = {
    loader: false,
    ShopImage_url: '',
    shop_name: '',
    availability: '',
    appointment: '',
    userId: '',
    owner_number: '',
    user_name: '',
    user_number: '',
    owner_token: '',
    user_token: '',
    B_startTime: '',
    B_endTime: '',
    A_startTime: '',
    A_endTime: '',
    message: null,
    name: '',
    can_make_app: false,
  }
  componentWillUnmount() {
    this.setState({ can_make_app: false })
  }
  async componentDidMount() {
    this.setState({ loader: true })
    var value1 = await AsyncStorage.getItem('@owner_number');
    var user_name;
    let sap = await firestore().collection('user').where('mobile_no', '==', value1).get()
    sap.forEach(element => {
      console.log(element.data())
      user_name = element.data().name
    });
    this.setState({ name: user_name })
    console.log("prop owner Id", this.props.route.params.ownerId)
    const owner = firestore().collection('owner').doc(this.props.route.params.ownerId).get().then(owner => {
      if (!owner.exists) {
        Alert.alert(
          'Warning',
          `Your Entered Wrong Owner Number`,
          [
            {
              text: 'OK',
              onPress: () => {
                this.props.navigation.navigate('qrcode_scanner');
              },
            },
          ],
          { cancelable: false },
        );
      }
      this.checkOwner_availability()
    })
  }
  async checkOwner_availability() {
    console.log('here is me')
    firestore()
      .collection('owner')
      .doc(this.props.route.params.ownerId.replace(/"/g, ""))
      .get()
      .then(snapshot => {

        console.log("user id : ", snapshot.data().user_Id)
        if (snapshot.data().Availablity === true) { // Checking whether user enabled online appointment booking
          var end_time = momemt(new Date( snapshot.data().appointment_end_time.seconds * 1000 + snapshot.data().appointment_end_time.nanoseconds / 1000000)).format('hh:mm:ss a')
          console.log("this is end", end_time)
          if ( end_time < moment(new Date()).format('hh:mm:ss a')) { // checking user of app booked an appointmnet after app-end-time.

            this.setState({ message: `Appointment time has over ${this.state.shop_name}` })
          } else {

            const d = snapshot.data().user_Id;
            console.log(d)

            const snap = firestore().doc(`user/${d}`).get();

            this.setState({
              // data of business owner from owner collection
              can_make_app: true,
              owner_number: snapshot.id,
              ShopImage_url: snapshot.data().image_url,
              shop_name: snapshot.data().Buisness_name,
              availability: snapshot.data().Availablity,
              userId: snapshot.data().user_Id,
              owner_token: snapshot.data().owner_token,
              B_startTime: snapshot.data().buisness_start_time,
              B_endTime: snapshot.data().buisness_end_time,
              A_startTime: snapshot.data().appointment_start_time,
              A_endTime: snapshot.data().appointment_end_time,

              // data of business owner from user collection
              user_number: snap.data().mobile_no,
              profileImage_url: snap.data().imageurl,
              user_token: snap.data().user_token
            })
          }
        } else {
          this.setState({ message: `Currently online appointment has stopped by business ${this.state.shop_name}` })
        }
      })
      .catch(err => { console.log(err) })
    this.setState({ loader: false })
  }
  async confirm_Appointment() {

    if (await AsyncStorage.getItem('@owner_number') == 'true') { // checking whether user already set an appointment or not
      Alert.alert('You have already set an appointment')
    } else {

      this.setState({ loader: true })
      const value = await AsyncStorage.getItem('@owner_number');
      let userId
      let uName
      let utoken

      let sap = await firestore().collection('user').where('mobile_no', '==', value).get()
      sap.forEach(element => {
        console.log(element.data())
        userId = element.id
        if (this.state.name) {
          uName = this.state.name
        }
        utoken = element.data().user_token
      });
      console.log(' confirm appointment ', userId + uName + utoken)
      const appoinment_number = await firestore()
        .collection('appointment-count')
        .doc(this.state.owner_number)
        .get()
        .then(async (response) => {
          console.log('appointment number for making an appointment from appoiintment count collection', response.data().Appointment_numbers)
          await firestore()
            .collection('appointment')
            .add({
              ownerId: this.state.owner_number,
              timestamp: new Date(),
              userId: userId,
              user_mobileNo: value,
              user_name: uName,
              Appointment_No: response.data().Appointment_numbers,
              owner_token: this.state.owner_token,
              user_token: utoken
            })
            .then(async (res) => {
              console.log(res)

              // SetAppointment flag set to true since user had made an appointment
              await AsyncStorage.setItem('@SetAppointment', 'true');
              await AsyncStorage.setItem('@Book_ownerId', this.props.route.params.ownerId);

              this.setState({ loader: false })
              this.props.navigation.navigate('Appointment_Details', { ownerId: this.props.route.params.ownerId.replace(/"/g, "") })
            })
        })
      // const addAppointment = functions().httpsCallable('online_appointment');
      // addAppointment({
      //   ownerId: this.state.owner_number,
      //   userId: userId,
      //   user_number: value,
      //   userName: uName,
      //   user_token: utoken,
      //   owner_token: this.state.owner_token
      // })
      //   .then(async (snap) => {
      //     console.log("appointment set for user :", snap)

      //     // SetAppointment flag set to true since user had made an appointment
      //     await AsyncStorage.setItem('@SetAppointment', 'true');
      //     await AsyncStorage.setItem('@Book_ownerId', this.props.route.params.ownerId);

      //     this.setState({ loader: false })
      //     this.props.navigation.navigate('Appointment_Details', { ownerId: this.props.route.params.ownerId.replace(/"/g, "") })
      //   })
      //   .catch(error => {
      //     this.setState({ loader: false })
      //     Alert.alert('Problem occured while an Appointment :' + error)
      //   })
    }
  }

  render() {
    return (
      <Container>
        <Modal transparent={true} visible={this.state.loader} >
          <View style={{ backgroundColor: 'rgba(0, 0, 0, 0.8)', alignItems: 'center', justifyContent: 'center', width: '100%', height: '100%' }}>
            <ActivityIndicator color='#2570EC' size='large' style={{ alignSelf: 'center' }} />
          </View>
        </Modal>
        {/* ------------------------- Header Bar ----------------------------------- */}
        <Header style={styles.header_bg} androidStatusBarColor="grey">
          <Left style={{ flex: 1 }}>
            <TouchableOpacity onPress={() => { this.props.navigation.navigate('qrcode_scanner') }}>
              <RN_Icon name='arrowleft' size={30} color="#000" />
            </TouchableOpacity>
          </Left>
          <Body style={styles.Header_Body}>
            <Title style={styles.Header_Name}>Book appointment</Title>
          </Body>
          <Right style={{ flex: 1 }} />
        </Header>
        <Container>
          <Text numberOfLines={1} style={{ position: 'absolute', zIndex: 1, color: '#FFFFFF', fontSize: 20, left: 170, top: hp('25%'), fontWeight: '700' }}>{this.state.shop_name}</Text>
          <Text numberOfLines={1} style={{ position: 'absolute', zIndex: 1, color: '#2570EC', fontSize: 16, left: 170, top: hp('30%'), fontWeight: '700' }}>{this.state.user_name}</Text>
          <Text numberOfLines={1} style={{ position: 'absolute', zIndex: 2, color: '#4F4F4F', fontSize: 14, left: 170, top: hp('34%'), fontWeight: '700' }}>{this.state.owner_number}</Text>
          {/* <View style={{ backgroundColor: 'rgba(0,0,0,0.6)' }}>
            <Image style={{ width: '100%', height: 200, zIndex: 10 }} source={this.state.ShopImage_url ? { uri: this.state.ShopImage_url } : require('../img/b1.jpg')} />
          </View> */}
          <ImageBackground style={{ width: wp('100%'), height: hp('30%'), backgroundColor: 'grey', justifyContent: 'center', alignItems: 'center' }} source={this.state.ShopImage_url ? { uri: this.state.ShopImage_url } : require('../img/b1.jpg')} >
            <View style={{ width: '100%', height: '100%', justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
            </View>
          </ImageBackground>
          <View style={{ position: 'absolute', justifyContent: 'center', alignItems: 'center', marginLeft: 27, top: hp('18%'), width: 136, height: 136 }}>
            <Image
              source={this.state.profileImage_url ? { uri: this.state.profileImage_url } : require('../img/face1.jpg')}
              style={{
                width: Dimensions.get('window').width * 0.3,
                height: Dimensions.get('window').width * 0.3, borderWidth: 3,
                borderRadius: Math.round(Dimensions.get('window').width + Dimensions.get('window').height) / 2,
                zIndex: 999, borderColor: '#FFFFFF'
              }} />
          </View>
          <Container style={styles.content}>
            <View
              style={{
                justifyContent: 'center',
                alignItems: 'center',
                borderBottomWidth: 1,
                borderColor: '#E4E4E4',
                top: 80
              }}
            />
          </Container>
        </Container>
        <Container contentContainerStyle={{ justifyContent: 'center', alignItems: 'center' }}>

          {this.state.can_make_app === true ?
            <Content >
              <Text style={{ fontFamily: 'Roboto_medium', fontWeight: '700', fontSize: 13, fontStyle: 'normal', marginLeft: wp('5%'), marginTop: hp('3%'), color: 'black' }}>
                Enter your name
                </Text>
              <TextInput
                value={this.state.name}
                onChangeText={(name) => {
                  this.setState({ name: name })
                }}
                keyboardType="ascii-capable"
                fontSize={26}
                placeholder='Your Name'
                style={{
                  marginTop: hp('1%'),
                  margin: hp('2%'),
                  color: '#5F6368',
                  borderColor: 'blue',
                  borderBottomWidth: 1,
                }} />
              <View style={{ justifyContent: 'center', alignItems: 'center' }}>
                <TouchableOpacity
                  onPress={() => this.confirm_Appointment()}
                  style={{
                    backgroundColor: '#2570EC',
                    width: wp('90%'),
                    height: hp('7.5%'),
                    borderRadius: 50,
                    justifyContent: 'center',
                    alignItems: 'center',
                    marginTop: hp('10%'),
                    marginBottom: hp('10%')
                  }}>
                  <Text style={{ color: 'white', fontSize: wp('4%'), }}>Confirm</Text>
                </TouchableOpacity>
              </View>
            </Content>
            :
            <Content contentContainerStyle={{ justifyContent: 'center', alignItems: 'center', width: '100%', height: '100%', padding: wp('3%') }}>
              <Text style={{ color: 'red', fontSize: 20, textAlign: 'center' }}>{this.state.message}</Text>
            </Content>}
        </Container>

      </Container>
    );
  }
}
export default confirm_Appointment;
